
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>the nullfactory - Parameterize Schema Name within a SSDT Database Project for Multi-Tenant Solutions</title>
	<meta name="description" content="the nullfactory">
	<meta name="keywords" content="SQL Server,SQL Server Data Tools" />

	<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="the nullfactory" />
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="/stylesheets/base.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/github.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/octicons.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="http://www.nullfactory.net/stylesheets/font-awesome/css/font-awesome.min.css" />
	<link href="https://fonts.googleapis.com/css?family=Lato|Open+Sans|Bungee" rel="stylesheet">
	<link rel="canonical" href="http://nullfactory.net/2015/05/ssdt-deployment-plan-modifer/" />
</head>
<body>
  <!-- header -->
	<div class="header-container">
	  <header>
		  <ul class="nav">
			<!--Change the  URL here if working on an absolute domain-->
			<li><a href="http://www.nullfactory.net"><span class="logo">the nullfactory</span></a></li>
			<li><a href="http://www.nullfactory.net/archive"><span style="margin-right: 6px;"></span>archive</a></li>
			<li><a href="http://www.nullfactory.net/about"><span style="margin-right: 6px;"></span>about</a></li>
		  </ul>
	  </header>
	</div>
  <!-- header -->

  <div class="container">
		<div class="listing">
	<div class="post other link">
		<h2><span class="mega-octicon octicon-file-text" style="min-width: 32px;"></span><a href="/2015/05/ssdt-deployment-plan-modifer/">Parameterize Schema Name within a SSDT Database Project for Multi-Tenant Solutions</a></h2>
		<p class="post-date">09 May 2015
				| <a href="/category/sql-server">SQL Server</a>
				| <a href="/category/sql-server-data-tools">SQL Server Data Tools</a>
	  </p>

		

		<p>I've been working on an multi-tenant solution recently and have been trying to come up with an efficient way to manage the database deployment and upgrade. The database is designed to segregate each tenant's data under its own schema namespace as such I need to generate a re-useable script that can be deployed against each tenant. The approach I am going to take is to first source control the database schema within a SQL Server Data Tools (SSDT) database project and then use it to generate the script that can be parameterized with the tenant information.</p>

<p>I first parameterized the the schema name as a SQLCMD variable - <code>$TenantName</code>: </p>

<p><img src="/images/posts/DeploymentPlanModifer/10_varcmd.png" alt="SqlCmd Variable" /></p>

<p>Next I tried to replace the schema name with the new variable, but this did not work as trying to build the solution now returns with a 71502 error as the project is no longer able to resolve and validate schema objects.</p>

<p><img src="/images/posts/DeploymentPlanModifer/20_SchemaValidation.png" alt="Schema Validation" /></p>

<p>SQLCMD does not have any complaints if I replace the <code>[dbo].</code> with <code>[$TenantName]</code> in the generated script so its the SSDT project that is attempting to maintain the integrity of database. </p>

<p>One possible way to overcome this is to <a href="http://stackoverflow.com/questions/10826014/suppress-some-warnings-in-sql-server-ssdt">suppress the 71502</a> by turning them into <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/9b698de1-9f6d-4e51-8c73-93c57355e768/treat-specific-warning-as-error?forum=ssdt">warnings</a>. The disadvantage in this approach is that you loose the rich validation in exchange for something that is essentially a deployment convenience.</p>

<p>Another duct tape and bubble gum approach would be to just have some kind of post deployment operation that does a find and replace on the schema name. Sure it would work, but that's not going to be reliable in the long run. </p>

<p>A little bit of research reveals that the proper way to alter the creation of deployment script process is to create a deployment plan modifier. A deployment plan modifier is essentially a class that inherits <code>DeploymentPlanModifier</code> and allows you to inject custom actions when deploying a SQL project. There does not seem to be much formal documentation on the process, so I relied a lot on <a href="https://msdn.microsoft.com/en-US/library/dn306642(v=vs.103).aspx">this article in MSDN</a>, the sample <a href="https://github.com/Microsoft/DACExtensions">DACExtensions</a> and what forum posts I could find. So with a lot of trial and error I wrote my own plan modifier that would replace the schema identifiers when the database project is published.</p>

<!--excerpt-->

<h2>How it works</h2>

<p>There are two main components to the solution; first one is the <code>SchemaSubstituteScriptContributor</code> that is based off of <code>DeploymentPlanModifier</code> that hosts and coordinates the injection process. And the other is <code>OverrideSchemaVisitor</code> which is based off of <code>TSqlFragmentVisitor</code> and does the actual schema substitution.</p>

<p>On the <code>SchemaSubstituteScriptContributor</code> class, I've overridden the <code>OnExecute</code> method to look for steps of type <code>DeploymentScriptDomStep</code> and once it find it, navigate down the class hierarchy until it reaches the actual <code>TSqlStatement</code>. And into this <code>TSqlStatement</code> I pass in a new instance of <code>OverrideSchemaVisitor</code> via the <code>Accept</code> method.</p>

<p>The <code>OverrideSchemaVisitor</code> has overridden methods to handle each type of statement that have schema references and need to be altered.</p>

<h2>Installation and Usage</h2>

<p>Visual Studio loads up any extensions that are available in the extensions folder every time it starts up. 
Now copy the assembly to the extensions folder that Visual Studio checks when it starts-up. I had some trouble locating as it was not in the location that the article mentioned (see <em>troubleshooting</em>). Eventually I found out that mine was located at <code>%ProgramFiles(x86)%\Microsoft Visual Studio 12.0\Common7\IDE\Extensions\Microsoft\SQLDB\DAC\120\Extensions</code>. </p>

<p><img src="/images/posts/DeploymentPlanModifer/30_ExtensionsFolder.png" alt="Extensions Folder" /></p>

<p>Next, in order for the database project to make use of the new extensions, I add the following properties to the database project <code>SqlProj</code> file:</p>

<pre><code>  &lt;PropertyGroup&gt;
    &lt;DeploymentContributors&gt;    
      $(DeploymentContributors);Nullfactory.SchemaSubstitute
    &lt;/DeploymentContributors&gt;
    &lt;ContributorArguments Condition="'$(Configuration)' == 'Debug'"&gt;
      $(ContributorArguments);Nullfactory.SchemaSubstitute.OldSchemaName=dbo;Nullfactory.SchemaSubstitute.NewSchemaName=$TenantSchema;
    &lt;/ContributorArguments&gt;
  &lt;/PropertyGroup&gt;
</code></pre>

<p>The parameters for the extension are passed via the <code>&lt;ContributorArguments&gt;</code> tag in a key-value pair format; where <code>Nullfactory.SchemaSubstitute.OldSchemaName</code> is the source schema name and <code>Nullfactory.SchemaSubstitute.NewSchemaName</code> is the new schema name. </p>

<p>Now that everything is setup, anytime the project is published the schema name would be substituted appropriately. </p>

<h2>Troubleshooting</h2>

<p>My first problem was trying to figure out where to deploy the extensions. Although the source article stated that it should be in the <code>%Program Files%\Microsoft SQL Server\110\DAC\Bin\Extensions</code> folder, Visual Studio refused to recognize it.</p>

<p><img src="/images/posts/DeploymentPlanModifer/40_UnableToLoadExtension.png" alt="Unable to Load Extensions" /></p>

<p>Digging through the forums, I found out that the locations in which visual studio checks for extensions depends on how it was installed. The multiple locations are there in <a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/be484b63-a6cc-4dac-a2c2-78a56ff5b502/where-is-the-microsoftsqlserverdacdll-that-includes-support-for-sql-server-2014?forum=ssdt">order to avoid conflicts and maintain backward compatibility</a>. Luckily, I found another post that shows how to <a href="https://social.msdn.microsoft.com/Forums/en-US/eb0ccd5b-e7e0-4d90-950b-a4c696f0bd6e/deployment-contributor-could-not-be-loaded?forum=ssdt">definitively identify the location that is being checked</a>:</p>

<blockquote>
  <ol>
  <li>Open a new command prompt as Administrator.</li>
  <li><p>Run the following command</p>
  
  <p><code>logman create trace -n DacFxDebug -p "Microsoft-SQLServerDataTools" 0x800 -o "%LOCALAPPDATA%\DacFxDebug.etl" -ets</code>
  <code>logman create trace -n SSDTDebug -p "Microsoft-SQLServerDataToolsVS" 0x800 -o "%LOCALAPPDATA%\SSDTDebug.etl" -ets</code></p></li>
  <li><p>Run whatever the target/issue scenario is in SSDT.</p></li>
  <li><p>Go back to the command prompt and run the following commands</p>
  
  <p><code>logman stop DacFxDebug -ets</code>
  <code>logman stop SSDTDebug -ets</code></p></li>
  </ol>
  
  <p>The resulting ETL files will be located at <code>%LOCALAPPDATA%\SSDTDebug.etl &amp; %LOCALAPPDATA%\DacFxDebug.etl</code> and can be navigated to using Windows Explorer.
  The <code>DacFxDebug.etl</code> file will contain extension load information. This can be opened and analyzed using the Windows Event Viewer.
  To do this, open the Windows Event Viewer application. In the right-hand panel, select Open Saved Log. Navigate to the location where you saved the log, open, and review the contents of the trace.</p>
</blockquote>

<p><img src="/images/posts/DeploymentPlanModifer/50_EventViewerLocation.png" alt="Event Viewer extensions location" /></p>

<p>I also had some trouble with referencing correct version of the assemblies. Here is the final list of references and the locations that they resided in. I am using SQL Server Data Tools version 12.0.50318.0 at the time of writing this post.</p>

<pre><code>System.ComponentModel.Composition - Framework

Microsoft.Data.Tools.Schema.Sql.dll - `C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\IDE\Extensions\Microsoft\SQLDB\DAC\120\Microsoft.Data.Tools.Schema.Sql.dll`
Microsoft.SqlServer.Dac.dll - `C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\IDE\Extensions\Microsoft\SQLDB\DAC\120\Microsoft.SqlServer.Dac.dll`
Microsoft.SqlServer.Dac.Extensions.dll - `C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\IDE\Extensions\Microsoft\SQLDB\DAC\120\Microsoft.SqlServer.Dac.Extensions.dll`
Microsoft.SqlServer.TransactSql.ScriptDom.dll - `C:\Program Files (x86)\Microsoft SQL Server\120\SDK\Assemblies\Microsoft.SqlServer.TransactSql.ScriptDom.dll`
</code></pre>

<h2>Final thoughts</h2>

<p>Its worth mentioning that this is not a problem for scripts that do not have a build action and scripts such as the pre and post deployment scripts are able to use the parameterized schema variable with no additional effort. </p>

<p>Next step for me is to look at integrating this into and publishing script as part of a team build. Stay tuned.  </p>

<p>I've hosted my final <a href="https://github.com/shanec-/Nullfactory-DACExtensions">implementation here</a> along with a sample database demonstrating its usage.</p>

<h2>References</h2>

<ul>
<li><a href="https://msdn.microsoft.com/en-US/library/dn306642(v=vs.103).aspx">MSDN - Walkthrough: Extend Database Project Deployment to Modify the Deployment Plan</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn306080(v=vs.103).aspx">MSDN - Walkthrough: Extend Database Project Build to Generate Model Statistics</a></li>
<li><a href="https://github.com/Microsoft/DACExtensions">Microsoft/DACExtensions</a></li>
<li><a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/eb0ccd5b-e7e0-4d90-950b-a4c696f0bd6e/deployment-contributor-could-not-be-loaded?forum=ssdt">MSDN Forum - Deployment Contributor could not be loaded</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/microsoft.sqlserver.dac.packageoptions.contributorarguments(v=sql.110).aspx">Technet - PackageOptions.ContributorArguments Property (Microsoft.SqlServer.Dac)</a></li>
<li><a href="http://stackoverflow.com/questions/10826014/suppress-some-warnings-in-sql-server-ssdt">Suppress some warnings in SQL Server SSDT - Stack Overflow</a></li>
<li><a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/9b698de1-9f6d-4e51-8c73-93c57355e768/treat-specific-warning-as-error?forum=ssdt">MSDN Forum - Treat specific warning as error?</a></li>
<li><a href="https://github.com/NuGet/NuGet.Operations/blob/master/ext/SqlServer/Microsoft.SqlServer.Dac.Extensions.xml">NuGet.Operations/Microsoft.SqlServer.Dac.Extensions.xml at master · NuGet/NuGet.Operations</a></li>
</ul>


	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<div class="addthis_sharing_toolbox"></div>

		<div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://nullfactory.net/2015/05/ssdt-deployment-plan-modifer/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'thenullfactory';
    var disqus_url = 'http://nullfactory.net/2015/05/ssdt-deployment-plan-modifer/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	</div>

	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53ba83f94ea9c78f" async="async"></script>
</div>
  </div>

  <!-- /.main -->

  <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-57983893-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>

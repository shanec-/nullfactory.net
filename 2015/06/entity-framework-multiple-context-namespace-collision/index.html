
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>the nullfactory - Entity Framework Namespace Collisions When Working with Multiple Contexts</title>
	<meta name="description" content="the nullfactory">
	<meta name="keywords" content="Entity Framework,SQL Server" />

	<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="the nullfactory" />
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="/stylesheets/base.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/github.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/octicons.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="http://www.nullfactory.net/stylesheets/font-awesome/css/font-awesome.min.css" />
	<link href="https://fonts.googleapis.com/css?family=Lato|Open+Sans|Bungee" rel="stylesheet">
	<link rel="canonical" href="http://nullfactory.net/2015/06/entity-framework-multiple-context-namespace-collision/" />
</head>
<body>
  <!-- header -->
	<div class="header-container">
	  <header>
		  <ul class="nav">
			<!--Change the  URL here if working on an absolute domain-->
			<li><a href="http://www.nullfactory.net"><span class="logo">the nullfactory</span></a></li>
			<li><a href="http://www.nullfactory.net/archive"><span style="margin-right: 6px;"></span>archive</a></li>
			<li><a href="http://www.nullfactory.net/about"><span style="margin-right: 6px;"></span>about</a></li>
		  </ul>
	  </header>
	</div>
  <!-- header -->

  <div class="container">
		<div class="listing">
	<div class="post other link">
		<h2><span class="mega-octicon octicon-file-text" style="min-width: 32px;"></span><a href="/2015/06/entity-framework-multiple-context-namespace-collision/">Entity Framework Namespace Collisions When Working with Multiple Contexts</a></h2>
		<p class="post-date">03 Jun 2015
				| <a href="/category/entity-framework">Entity Framework</a>
				| <a href="/category/sql-server">SQL Server</a>
	  </p>

		

		<p>I came across the following exception whilst attempting working with a solution that contained a <em>couple of</em> Entity Framework (EF) 6 database contexts.</p>

<pre><code>System.Data.Entity.Core.MetadataException

Schema specified is not valid. Errors: 
The mapping of CLR type to EDM type is ambiguous because multiple CLR types match the EDM type 'Setting'. Previously found CLR type 'SqlHelper.Primary.Setting', newly found CLR type 'SqlHelper.Secondary.Setting'.

at System.Data.Entity.Core.Metadata.Edm.ObjectItemCollection.LoadAssemblyFromCache(Assembly assembly, Boolean loadReferencedAssemblies, EdmItemCollection edmItemCollection, Action`1 logLoadMessage)
at System.Data.Entity.Core.Metadata.Edm.ObjectItemCollection.ExplicitLoadFromAssembly(Assembly assembly, EdmItemCollection edmItemCollection, Action`1 logLoadMessage)
at System.Data.Entity.Core.Metadata.Edm.MetadataWorkspace.ExplicitLoadFromAssembly(Assembly assembly, ObjectItemCollection collection, Action`1 logLoadMessage)
at System.Data.Entity.Core.Metadata.Edm.MetadataWorkspace.LoadFromAssembly(Assembly assembly, Action`1 logLoadMessage)
at System.Data.Entity.Core.Metadata.Edm.MetadataWorkspace.LoadFromAssembly(Assembly assembly)
at System.Data.Entity.Internal.InternalContext.TryUpdateEntitySetMappingsForType(Type entityType)
at System.Data.Entity.Internal.InternalContext.UpdateEntitySetMappingsForType(Type entityType)
at System.Data.Entity.Internal.InternalContext.GetEntitySetAndBaseTypeForType(Type entityType)
at System.Data.Entity.Internal.Linq.InternalSet`1.Initialize()
at System.Data.Entity.Internal.Linq.InternalSet`1.get_InternalContext()
at System.Data.Entity.Internal.Linq.InternalSet`1.ActOnSet(Action action, EntityState newState, Object entity, String methodName)
at System.Data.Entity.Internal.Linq.InternalSet`1.Add(Object entity)
at System.Data.Entity.DbSet`1.Add(TEntity entity)
at MultiContextConsoleApp.Program.Main(String[] args) in e:\shane\Projects\Orca\Sandbox\MultiContextConsoleApp\MultiContextConsoleApp\Program.cs:line 16
at System.AppDomain._nExecuteAssembly(RuntimeAssembly assembly, String[] args)
at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)
at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()
at System.Threading.ThreadHelper.ThreadStart_Context(Object state)
at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)
at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)
at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)
at System.Threading.ThreadHelper.ThreadStart()
</code></pre>

<!--excerpt-->

<h2>Reproducing the Problem</h2>

<p>Here's a quick run down of the steps required to reproduce the scenario:</p>

<ol>
<li>Start off by creating two databases.</li>
<li><p>Create a new table with the same name on each of them.</p>

<p><img src="/images/posts/EFNamespaceConflict/10_DatabaseSchema.png" alt="Database Schema" /></p></li>
<li><p>Next, open up Visual Studio and create a Class Library project to host both EF database contexts.</p></li>
<li><p>Within the same project, create two EF (<em>ADO.NET Entity Data Model</em>) contexts; one for each database. Ensure that each context is under its own namespace.</p>

<p><img src="/images/posts/EFNamespaceConflict/15_InitialProjectStructure.png" alt="Project Structure" /></p>

<p><img src="/images/posts/EFNamespaceConflict/20_PrimaryContext.png" alt="Primary Context" /></p>

<p><img src="/images/posts/EFNamespaceConflict/30_SecondaryContext.png" alt="Secondary Context" /></p>

<p><img src="/images/posts/EFNamespaceConflict/40_PrimarySetting.png" alt="Primary Context Settings File" /></p>

<p><img src="/images/posts/EFNamespaceConflict/50_SecondarySetting.png" alt="Secondary Context Settings File" /></p></li>
<li><p>Next, let's create a simple console application that would act as the client and invoke operations on the contexts. </p></li>
<li><p>Run the application - an exception is thrown the moment there is any kind of interaction with either of the contexts. </p>

<p><img src="/images/posts/EFNamespaceConflict/60_Exception.png" alt="SSMS Context Menu" /></p></li>
</ol>

<h2>The Solution</h2>

<p>This issue is only reproducible when working with multiple database contexts that have tables with the same name and share the same assembly. It does not even matter that the contexts are across different namespaces. </p>

<p>The problem appears to be how Entity Framework resolves namespaces, <a href="http://entityframework.codeplex.com/workitem/483">this ticket goes into more detail</a>. I was able to reproduce this with the latest version of EF and a fix does not appear to be on the immediate schedule. </p>

<p>Luckily there are couple of workarounds which are pretty straightforward:</p>

<ol>
<li>Make sure that that both contexts don't share tables with the same name - <em>not the most practical approach</em>.</li>
<li><p>Restructure the solution by isolating the database contexts within their own assemblies.</p>

<p><img src="/images/posts/EFNamespaceConflict/70_NewProjectStructure.png" alt="SSMS Context Menu" />   </p></li>
</ol>

<h2>References</h2>

<ul>
<li><a href="http://entityframework.codeplex.com/workitem/483">CodePlex - Entity Framework - View Issue #483: Can't map two classes with same name from different namespace</a></li>
<li><a href="http://stackoverflow.com/questions/14927391/the-mapping-of-clr-type-to-edm-type-is-ambiguous-with-ef-6-5">StackOverflow.com - c# - The mapping of CLR type to EDM type is ambiguous with EF 6 &amp; 5?</a></li>
<li><a href="https://social.msdn.microsoft.com/Forums/en-US/5a8ea003-c6bc-4fc6-ad2a-634f09447c49/ef4-mapping-of-clr-type-to-edm-type-is-ambiguous-error?forum=adodotnetentityframework">MSDN Forum - EF4 Mapping of CLR type to EDM type is ambiguous error.</a></li>
</ul>


	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<div class="addthis_sharing_toolbox"></div>

		<div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://nullfactory.net/2015/06/entity-framework-multiple-context-namespace-collision/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'thenullfactory';
    var disqus_url = 'http://nullfactory.net/2015/06/entity-framework-multiple-context-namespace-collision/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	</div>

	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53ba83f94ea9c78f" async="async"></script>
</div>
  </div>

  <!-- /.main -->

  <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-57983893-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>

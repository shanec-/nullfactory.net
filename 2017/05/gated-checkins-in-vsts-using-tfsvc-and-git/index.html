
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>the nullfactory</title>
	<meta name="description" content="the nullfactory">
	<meta name="keywords" content="Visual Studio Team Services,TFSVC,ALM,Git" />

	<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="the nullfactory" Feed">
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/base.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/github.css" type="text/css" />
	<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/octicons.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="http://www.nullfactory.net/stylesheets/font-awesome/css/font-awesome.min.css" />
	<link rel="canonical" href="http://nullfactory.net/2017/05/gated-checkins-in-vsts-using-tfsvc-and-git/" />
</head>
<body>
  <!-- header -->

	<div class="header-container">
	  <header>
		  <ul class="nav">
			<!--Change the  URL here if working on an absolute domain-->
			<li><a href="http://www.nullfactory.net"><span class="mega-octicon octicon-terminal" style="margin-right: 6px;"></span>the nullfactory</a></li>
			<li><a href="http://www.nullfactory.net/archive"><span class="mega-octicon octicon-book" style="margin-right: 6px;"></span>archive</a></li>
			<li><a href="http://www.nullfactory.net/about"><span class="mega-octicon octicon-person" style="margin-right: 6px;"></span>about</a></li>
		  </ul>
	  </header>
	</div>

  <!-- header -->

  <div class="container">
	
<div class="listing">
	<div class="post other link">
		<h2><span class="mega-octicon octicon-file-text" style="min-width: 32px;"></span><a href="/2017/05/gated-checkins-in-vsts-using-tfsvc-and-git/">Gated Check-ins in Visual Studio Team Services using TFSVC and Git</a></h2>
		<p class="post-date">15 May 2017
				| <a href="/category/visual-studio-team-services">Visual Studio Team Services</a>
				| <a href="/category/tfsvc">TFSVC</a>
				| <a href="/category/alm">ALM</a>
				| <a href="/category/git">Git</a>
	  </p>

		

		<p>A continuous integration build ensures that the code within a source control repository can be compiled successfully after a commit. <a href="https://www.thoughtworks.com/continuous-integration">It is defined as</a>:</p>

<blockquote>
  <p>Continuous Integration (CI) is a development practice that requires developers to integrate code into a shared repository several times a day. Each check-in is then verified by an automated build, allowing teams to detect problems early. </p>
</blockquote>

<p>Where as CI builds occur after a commit has been merged into the repository, a gated check-in is a "pessimistic" process that would treat a commit as completed <strong>only</strong> if the result of it being merged with the repository is a successful build.</p>

<p>In this post I will try my hand in setting up a gated check-in using Visual Studio Team Services (VSTS). I will start off with TFSVC as the underlying version control system and then replicate the same functionality using Git.</p>

<h2>Configuring a Gated Check-In Using TFSVC</h2>

<p><em>Prerequisite: A repository already exists in the remote server with project code checked-in. I will be using one of my demo CRM projects.</em></p>

<ol>
<li><p>Define the steps for the build that would act as the verification build.</p>

<p><img src="/images/posts/TfsvcGatedCheckIns/10_CIBuild.png" alt="Verification Build" /></p></li>
<li><p>Navigate to the <code>Triggers</code> tab within the build definition and enabling the <code>Gated Check-In</code> trigger.</p>

<p><img src="/images/posts/TfsvcGatedCheckIns/20_GatedCheckIn.png" alt="Gated Check-In" /></p></li>
</ol>

<!--excerpt-->

<ol>
<li>Leave the <code>Run continuous integration triggers for committed changes</code> unchecked. If a CI build has been configured and <a href="https://www.visualstudio.com/en-us/docs/build/define/triggers">this option was checked</a> then an additional CI build would run after a successful gated check-in build.</li>
</ol>

<h3>Testing Out the Process</h3>

<ol>
<li>Make a change to the code that causes an compilation error. </li>
<li><p>Check-in this code into the version control. Upon clicking the <code>Check In</code> button within Visual Studio, the following warning dialog appears indicating that the new check-in would be stored as a shelveset until its successful completion: </p>

<p><img src="/images/posts/TfsvcGatedCheckIns/30_GatedWarning.png" alt="Gated Check-In Warning" /></p></li>
<li><p>Uncheck the <code>Preserve my pending changes locally</code> option and click on the <code>Build Changes</code> button to kick off the build.</p></li>
<li><p>Next, navigate to builds definition folder and confirm that the verification build was in fact triggered and that it failed as expected.</p>

<p><img src="/images/posts/TfsvcGatedCheckIns/40_GatedCIBuild.png" alt="Failed Gated Build" /></p></li>
<li><p>Since we did not opt-in to preserve our check-ins locally, let's retrieve it from the generated shelveset. Back in Visual Studio, navigate to the<code>Team Explorer</code> window and from the <code>Actions</code> menu click the <code>Find Shelvesets</code> </p>

<p><img src="/images/posts/TfsvcGatedCheckIns/50_FindShelveset.png" alt="Failed Gated Build" /></p></li>
<li><p>Select the last shelveset that failed the build - it would be prefixed with <code>Gated_</code>.</p>

<p><img src="/images/posts/TfsvcGatedCheckIns/60_ShelvesetAssigned.png" alt="Shelvesets Assigned" /></p></li>
<li><p>Fix the compilation errors we introduced previously and check in the changes.</p>

<p><img src="/images/posts/TfsvcGatedCheckIns/70_Recheckin.png" alt="Check-in Corrections" /></p></li>
<li><p>Verify that the new check in and resultant gated-build is successful. </p>

<p><img src="/images/posts/TfsvcGatedCheckIns/80_BuildSuccess.png" alt="Successful Gated Build" /></p></li>
<li><p>Now that the check-in has been merged, get the latest version of the code using Visual Studio.</p></li>
</ol>

<h2>Configuring a Gated Check-In Using Git</h2>

<p>Branch Policies are used to implement gated check-ins in git. It is a feature in VSTS that provides rules to govern the activity within a branch and ensure the code quality and change management standards are followed. </p>

<p>There are many <a href="https://www.visualstudio.com/en-us/docs/git/branch-policies">policies available</a> but I am interested only in the ones related to when a pull request is made.</p>

<p>Given the way that git operates, it cannot be configured to have a gated check-in against every commit as we did with TFSVC. Instead the policy would be enforced during the pull requests between the topic branch to the <code>master</code> branch.</p>

<p>The following steps describe the process of setting up a gated check-in on the <code>master</code> branch:</p>

<p><em>Prerequisite: A repository already exists in the remote server with project code checked-in. I will be using one of my demo CRM projects.</em></p>

<ol>
<li><p>Start off by defining a build that would act as the verification.</p>

<p><img src="/images/posts/GitGatedCheckIns/05_verificationbuild.png" alt="Verification Build" /></p></li>
<li><p>Navigate to the repository.</p></li>
<li>Click on the <code>Branches</code> menu.</li>
<li><p>Click on the ellipsis against the <code>master</code> branch and on the menu and select <code>Branch Policies</code>.</p>

<p><img src="/images/posts/GitGatedCheckIns/10_updatebranch.png" alt="Update Branch" /></p></li>
<li><p>Under the <code>Automatically build pull requests</code> menu check the <code>When team members create or update a pull request into the master branch, queue this build:</code> option.</p></li>
<li><p>Then select the build that you want to use to perform the verification.</p>

<p><img src="/images/posts/GitGatedCheckIns/20_setupbranchpolicy.png" alt="Branch Policies" /></p></li>
<li><p>Click <code>Save Changes</code> button to confirm the changes.</p></li>
</ol>

<h3>Testing out the Policy</h3>

<p>Now let's test our branch policy:</p>

<ol>
<li>On the development machine, create a new local branch called <code>development</code>.</li>
<li>Commit a change that causes a compilation error. </li>
<li><p>Push the branch and changes to the remote repository.</p>

<p><img src="/images/posts/GitGatedCheckIns/30_devbranch.png" alt="Development Branch" /></p></li>
<li><p>Next, log into VSTS and navigate to the <code>Branches</code> menu.</p></li>
<li>Click on the ellipsis against the <code>development</code> branch to open up the context menu. </li>
<li><p>Select the <code>New pull request</code> option.</p>

<p><img src="/images/posts/GitGatedCheckIns/40_newpullrequest.png" alt="New pull request" /></p></li>
<li><p>Provide a meaningful <code>Title</code> and <code>Description</code> and click on the <code>Create</code> button.</p>

<p><img src="/images/posts/GitGatedCheckIns/50_pullrequestdialog.png" alt="New pull request" /></p></li>
<li><p>Confirm that a new verification build has been queued for the pull request.</p>

<p><img src="/images/posts/GitGatedCheckIns/60_verifybuild.png" alt="Verification Build" /></p></li>
<li><p>Confirm that this build failed.</p>

<p><img src="/images/posts/GitGatedCheckIns/70_confirmbuildfailed.png" alt="Confirm Build Failure" /></p></li>
<li><p>Now let's fix the code, commit and push the change in to the repository.</p>

<p><img src="/images/posts/GitGatedCheckIns/80_fixbuild.png" alt="Fix the build" /></p></li>
<li><p>Verify that the build policy has detected the new commit and automatically associated it with the pull request. </p></li>
<li><p>Confirm that a new build was triggered as a result and that its successful. The successful build completes the pull request.</p>

<p><img src="/images/posts/GitGatedCheckIns/90_completedpullrequest.png" alt="Complete Pull Request" /></p></li>
</ol>

<h2>References</h2>

<ul>
<li><a href="https://www.thoughtworks.com/continuous-integration">Continuous integration | ThoughtWorks</a></li>
<li><a href="https://www.visualstudio.com/en-us/docs/build/define/triggers">Build definition triggers</a></li>
<li><a href="https://www.visualstudio.com/en-us/docs/tfvc/check-folder-controlled-by-gated-check-build-process">Check in to a folder that is controlled by a gated check-in build process</a></li>
<li><a href="https://channel9.msdn.com/Events/Visual-Studio/Visual-Studio-2015-Final-Release-Event/Git-Branches-and-Policies-in-Team-Foundation-Server-2015">Git Branches and Policies in Team Foundation Server 2015 | Visual Studio 2015 Final Release Event | Channel 9</a></li>
<li><a href="https://blogs.msdn.microsoft.com/buckh/2016/03/20/gated-checkin-for-git-using-branch-policies-to-run-a-build-in-vsts-and-tfs/">Gated checkin for Git: Using Branch Policies to run a build in VSTS and TFS – Buck Hodges</a></li>
<li><a href="https://www.visualstudio.com/en-us/docs/git/branch-policies">Protect your Git branches with policies | Team Services &amp; TFS</a></li>
</ul>


	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<div class="addthis_sharing_toolbox"></div>

		<div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://nullfactory.net/2017/05/gated-checkins-in-vsts-using-tfsvc-and-git/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'thenullfactory';
    var disqus_url = 'http://nullfactory.net/2017/05/gated-checkins-in-vsts-using-tfsvc-and-git/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	</div>

	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53ba83f94ea9c78f" async="async"></script>
</div>

  </div>

  <!-- /.main -->

  <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-57983893-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>the nullfactory - Strategy for Maintaining CRM Solutions in Team Foundation Server using Microsoft.Xrm.Data.PowerShell</title>
	<meta name="description" content="the nullfactory">
	<meta name="keywords" content="Dynamics CRM,Team Foundation Server,ALM" />

	<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="the nullfactory" Feed" />
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="/stylesheets/base.css" type="text/css" />
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/github.css" type="text/css" />
	<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://www.nullfactory.net/stylesheets/octicons.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="http://www.nullfactory.net/stylesheets/font-awesome/css/font-awesome.min.css" />
	<link href="https://fonts.googleapis.com/css?family=Lato|Open+Sans" rel="stylesheet">
	<link rel="canonical" href="http://nullfactory.net/2016/01/crm-solution-tfs-microsoft-xrm-data-powershell/" />
</head>
<body>
  <!-- header -->
	<div class="header-container">
	  <header>
		  <ul class="nav">
			<!--Change the  URL here if working on an absolute domain-->
			<li><a href="http://www.nullfactory.net"><span class="mega-octicon octicon-terminal" style="margin-right: 6px;"></span>the nullfactory</a></li>
			<li><a href="http://www.nullfactory.net/archive"><span class="mega-octicon octicon-book" style="margin-right: 6px;"></span>archive</a></li>
			<li><a href="http://www.nullfactory.net/about"><span class="mega-octicon octicon-person" style="margin-right: 6px;"></span>about</a></li>
		  </ul>
	  </header>
	</div>
  <!-- header -->

  <div class="container">
		<div class="listing">
	<div class="post other link">
		<h2><span class="mega-octicon octicon-file-text" style="min-width: 32px;"></span><a href="/2016/01/crm-solution-tfs-microsoft-xrm-data-powershell/">Strategy for Maintaining CRM Solutions in Team Foundation Server using Microsoft.Xrm.Data.PowerShell</a></h2>
		<p class="post-date">21 Jan 2016
				| <a href="/category/dynamics-crm">Dynamics CRM</a>
				| <a href="/category/team-foundation-server">Team Foundation Server</a>
				| <a href="/category/alm">ALM</a>
	  </p>

		

		<p>I've come across a few strategies on the internet on achieving this goal, with each one having its pros and cons. This post describes my own attempt at setting up a development workflow that can be integrated with the team builds.</p>

<p>This implementation at its core revolves around the <a href="https://github.com/seanmcne/Microsoft.Xrm.Data.PowerShell"><code>Microsoft.Xrm.Data.PowerShell</code></a> module and the <code>Solution Packager</code> tool provided with the official SDK. I have minimized the use of 3rd party libraries and have intentionally excluded the use of any visual studio extensions or helper tools.</p>

<h2>Setting up the Tools</h2>

<h3>Installing Microsoft.CrmSdk.CoreTools</h3>

<p>Let's start off by creating a "tooling" project that would act as a hosts for the tools and scripts involved in the process.</p>

<ol>
<li>Create a class library project to host the tools using for building the packages. I named mine <code>Nullfactory.Crm.Tooling</code>.</li>
<li><p>Install the <code>Microsoft.CrmSdk.CoreTools</code> nuget package by running the following command in the package manager console: </p>

<p><code>Install-Package Microsoft.CrmSdk.CoreTools -Project Nullfactory.Crm.Tooling</code></p>

<p>This nuget package includes the <code>SolutionPackager.exe</code> tool.</p>

<p><img src="/images/posts/CrmDataPowershell/10_InstallCoreTools.png" alt="Install Crm Core Tools" /></p></li>
<li><p>Next, clean up the project by removing the default <code>Class1.cs</code> file as well as the <code>Debug</code> and <code>Release</code> within the <code>bin</code> folder.</p></li>
<li><p>Update the solution configurations to not build this project. Do this by navigating to the solution property pages > <code>Configuration Properties</code> and un-ticking the check box against the build column.</p>

<p><img src="/images/posts/CrmDataPowershell/20_DontBuild.png" alt="Do not Build Project" /></p></li>
</ol>

<!--excerpt-->

<h3>Install Microsoft.Xrm.Data.PowerShell</h3>

<p>The <code>Microsoft.Xrm.Data.Powershell</code> module makes interacting with CRM so much easier - it is used to connect to CRM and export the solutions. </p>

<p>Follow these steps to install it:</p>

<ol>
<li>Download the latest release from <a href="https://github.com/seanmcne/Microsoft.Xrm.Data.PowerShell/releases/">here</a>. Detailed installation instructions can be found on their github page. </li>
<li><p>Ensure that the zip file is unblocked <em>before extracting the contents</em>. Once extracted, add them into the bin folder as part of the tooling project.</p>

<p><img src="/images/posts/CrmDataPowershell/30_UnblockZip.png" alt="Unblock Zip Before Extraction" /></p></li>
<li><p>Since this module would have to be installed on each of the developer machines, I created a helper script that automates it - <code>Install-Microsoft.Xrm.Data.Powershell.ps1</code>. Add this as part of the project as well. </p>

<p><img src="/images/posts/CrmDataPowershell/40_InstallPowershell.png" alt="Install Microsoft.Xrm.Data.Powershell" /></p>

<p><a href="https://github.com/shanec-/Crm-PowershellBuildDemo/blob/master/src/Nullfactory.Crm.Tooling/bin/Install-Microsoft.Xrm.Data.Powershell.ps1">Download the install script here</a>.</p></li>
</ol>

<h2>Setting up the Projects</h2>

<p>Next, lets create class library projects for each of the CRM Solutions. This makes visualizing and managing the solution from within Visual Studio easier. And more importantly, give us the ability to add a msbuild tasks.</p>

<p>Edit the <code>csproj</code> file of the newly created project and add the following ms build task. </p>

<pre><code>&lt;Target Name="Build"&gt;
    &lt;Exec Command="$(SolutionDir)\Nullfactory.Crm.Tooling\bin\coretools\SolutionPackager.exe /action:pack /packagetype:both /folder:$(MSBuildProjectDirectory) /zipfile:$(OutDir)$(MSBuildProjectName).zip" /&gt;
&lt;/Target&gt;
</code></pre>

<p>This ensures that both unmanaged and managed versions of the CRM solution is packaged anytime the project is built. </p>

<p>Optionally, remove the <code>properties</code> folder and <code>AssemblyInfo.cs</code> file as they will not be required for these projects.</p>

<h3>Add Solution Export and Synchronization Script</h3>

<p>Add the <code>Sync-CrmSolution.ps1</code> and <code>Sync-CrmSolution.Param.ps1</code> files into the tooling project. These scripts can be downloaded <a href="https://github.com/shanec-/Crm-PowershellBuildDemo/blob/master/src/Nullfactory.Crm.Tooling/bin/Sync-CrmSolution.ps1">here</a> and <a href="https://github.com/shanec-/Crm-PowershellBuildDemo/blob/master/src/Nullfactory.Crm.Tooling/bin/Sync-CrmSolution.Param.ps1">here</a>.</p>

<p><img src="/images/posts/CrmDataPowershell/60_SyncScriptsInstalled.png" alt="Installed Synchronization Scripts" /></p>

<p>The <code>Sync-CrmSolution.ps1</code> script handles the exporting of the solution and performs the following actions:</p>

<ol>
<li>Deletes all the artifacts from the CRM solution project folder.</li>
<li>Connects to the organization and exports both the managed and un-managed versions of the solution.</li>
<li>Finally, unpacks them into the previously emptied folder.</li>
</ol>

<p>The <code>Sync-CrmSolution.Param.ps1</code> script acts as a controller script with the actual parameters. Each developer would update this script to point to their own development CRM organization.</p>

<h2>Unpacking and Synchronizing</h2>

<p>Next, we unpack the initial version of the solution into the project. This is done using the following steps: </p>

<ol>
<li><p>Ensure that the <code>Sync-CrmSolution.Param.ps1</code> script is pointing to a valid CRM organization and solution and execute the script.</p>

<p><img src="/images/posts/CrmDataPowershell/50_ExtractingSolution.png" alt="Extracting Solution" /></p></li>
<li><p>Once the solution has been unpacked, add the new artifacts into the project.</p>

<p><img src="/images/posts/CrmDataPowershell/70_SolutionExtracted.png" alt="Crm Solution Extracted" /></p></li>
<li><p>Check-in all the changes done so far.</p></li>
</ol>

<p>Now that the initial version is in source control, it raises the problem of figuring out the files that have changes in subsequent extractions. How do you figure out which files have changed so that only those files are check-in?</p>

<p>One of my colleague introduced me to an interesting technique that hes been using for a while. I like it a lot as its simple, effective and avoids having to do any explicit TFS integration.   </p>

<p>This method leverages Microsoft Visual Studio Team Foundation Server 2015 Power Tools in order to identify the files changed in the working folder. It requires each developer <a href="https://visualstudiogallery.msdn.microsoft.com/898a828a-af00-42c6-bbb2-530dc7b8f2e1">install</a> it on their development box.</p>

<p>Whenever a developer synchronizes their version of the solution using the <code>Sync-CrmSolution.Param.ps1</code> script, the power tools would automatically detect and check out the edited files. One would still have to manually include new and deleted files into the project via the detected changes dialog, but that's a minor inconvenience I can live with. </p>

<p>A positive side effect of this method is that we no longer have to be concerned about the <code>allowDelete</code> and <code>allowWrite</code> parameters in the Solution Packager tool.</p>

<h2>Final Thoughts</h2>

<p>Now any time the class libraries hosting the solutions are built, the output would be packaged zip files for both managed and un-managed CRM solutions. </p>

<p>Although I did not setup up separate projects for plugins and web resources in this example, it is certainly possible.  </p>

<p>I might also explore converting the entire <code>Nullfactory.Crm.Tooling</code> project into a template in a future post. It should make it a lot more easier integrate it into new projects.</p>

<p>Finally, I feel that the day-to-day operation part of this process is a little bit tedious and does not offer any significant advantage over the convenience of using an Visual Studio extension. I knew this going in, but I wanted to have an understanding of the work involved in setting this up. </p>

<h2>References</h2>

<ul>
<li><a href="https://github.com/seanmcne/Microsoft.Xrm.Data.PowerShell/releases/">Releases · seanmcne/Microsoft.Xrm.Data.PowerShell</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/jj602987.aspx">Use the SolutionPackager tool to compress and extract a solution file</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd878350(v=vs.85).aspx">Installing Modules</a></li>
<li><a href="http://blogs.msdn.com/b/koteshb/archive/2010/02/13/powershell-creating-a-pscredential-object.aspx">PowerShell - How to create a PSCredential object - Kotesh Bandhamravuri - Site Home - MSDN Blogs</a></li>
<li><a href="https://www.youtube.com/watch?v=65MVXzMAWyg">Integrating SolutionPackager into Visual Studio - YouTube</a></li>
<li><a href="http://waelhamze.com/2014/01/12/dynamics-crm-parallel-development-with-solution-packager/">Dynamics CRM Parallel Development with Solution Packager | Wael Hamze</a></li>
<li><a href="https://visualstudiogallery.msdn.microsoft.com/898a828a-af00-42c6-bbb2-530dc7b8f2e1">Microsoft Visual Studio Team Foundation Server 2015 Power Tools extension</a></li>
</ul>


	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<div class="addthis_sharing_toolbox"></div>

		<div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://nullfactory.net/2016/01/crm-solution-tfs-microsoft-xrm-data-powershell/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'thenullfactory';
    var disqus_url = 'http://nullfactory.net/2016/01/crm-solution-tfs-microsoft-xrm-data-powershell/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	</div>

	<!-- Go to www.addthis.com/dashboard to customize your tools -->
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53ba83f94ea9c78f" async="async"></script>
</div>
  </div>

  <!-- /.main -->

  <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-57983893-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>
